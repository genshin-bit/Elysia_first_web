# 解决方案列表动态化方案（基于 ACF 与 WordPress 原生能力）

> 适用范围：  
> - 入口模板：`page-solution.php`  
> - 列表相关模板：`template-parts/solution/*`（尤其是 `solution-archive-header.php` 与 `layout-two-column-solution.php`）  
> - 仅使用：ACF 插件 + WordPress 原生能力（不额外增加其他插件）

---

## 一、整体思路

- 使用现有/规划的“解决方案”内容类型（假设为自定义 post type：`solution`，若实际为 `post` 则相应替换即可）作为数据源。
- 列表页不再写死解决方案内容，全部通过 **WP_Query + ACF 配置** 动态生成。
- ACF 只承担“配置和装饰”职责（例如：列表标题、副标题、每页数量、默认排序、推荐解决方案等），不替代文章本身的内容。
- 模板层保持现有 Elementor 导出的 HTML 结构和 class，避免破坏现有样式。
- 充分复用已有组件：  
  - 列表卡片展示复用 `template-parts/loop/loop-solution-grid.php`  
  - 右侧推荐产品复用 `template-parts/solution/sidebar-feature-product.php`  
  - 其他全局组件（如面包屑、分享、导航等）继续通过 `get_template_part()` 复用
- 通过统一的 post_type 与 URL 结构，实现 **解决方案列表页 ↔ 解决方案详情页 ↔ 相关产品页** 的联动。

---

## 二、数据结构与内容模型设计

### 2.1 解决方案内容来源

- 列表页数据全部来自“解决方案”文章：
  - 若当前已存在 `solution` 自定义文章类型，则直接使用；
  - 若当前使用的是 `post` 分类中的某一分类/标签，则在查询中改为按分类筛选；
  - 关键是：列表页不再写死任意解决方案条目，而是完整走 WordPress 内容模型。

### 2.2 分类与标签（Taxonomy）

用于按行业、应用场景等对解决方案进行组织：

- 若已有自定义分类法（如 `solution_category`）：  
  - 后台将每条解决方案文章分配到一个或多个 `solution_category`。
- 若无自定义分类法，可选择：
  - 使用原生 `category` 作为解决方案分类；或  
  - 通过现有代码注册 `solution_category`，供解决方案专用。

后续列表页可以通过 taxonomy 实现分类筛选，如：  
`/solution/?solution_cat=building` 仅查看建筑行业解决方案。

### 2.3 ACF 字段用途（只做“配置层”）

为避免将核心内容锁死在 ACF 中，本方案只用 ACF 做“列表页配置”：

**建议字段绑定位置：**

- 绑定到具体页面 `page-solution`：  
  - ACF 显示位置条件：页面等于「解决方案列表页」  
  - 优点：配置与页面一一对应，语义清晰  
- 或者绑定到 Options Page：  
  - 适合多语言或多个入口复用同一套配置

**建议字段示例：**

- 列表页文案类：
  - `solution_list_title`：列表主标题（如“解决方案”）
  - `solution_list_subtitle`：副标题
  - `solution_list_intro`：列表说明文本（可为 WYSIWYG）
  - `solution_archive_banner_image`：列表页顶部 Banner 图
  - `solution_archive_banner_desc`：Banner 区域描述文字
- 列表行为配置：
  - `solution_list_items_per_page`：每页显示数量（默认 9 或 12）
  - `solution_list_default_order`：默认排序规则（如：`date_desc` / `date_asc` / `menu_order`）
  - `solution_list_featured_ids`：推荐解决方案（ACF Relationship 或 Post Object，多选）

---

## 三、模板结构与组件复用策略

### 3.1 `page-solution.php`：仅做编排（Orchestrator）

现有核心结构（示意）：

```php
<main id="main" class="site-main hfeed" itemscope="itemscope" itemtype="https://schema.org/CreativeWork">
    <div data-elementor-type="archive" data-elementor-id="5259" class="elementor elementor-5259 elementor-location-archive" data-elementor-post-type="elementor_library">
        <?php get_template_part('template-parts/solution/solution-archive-header'); ?>
        <?php get_template_part('template-parts/solution/layout-two-column-solution'); ?>
    </div>
</main>
```

**动态化改造原则：**

- 保持 `page-solution.php` 不直接写查询逻辑，仅负责调用子模板：
  - 顶部：`solution-archive-header.php`（头部 + 介绍区块）
  - 主体：`layout-two-column-solution.php`（列表 + 侧边栏布局）
- 若后续需要增加其他区域（如底部 CTA 区块、FAQ 等），也通过 `get_template_part()` 引入独立模板，保持“单一职责”。

### 3.2 组件复用清单

- 列表卡片展示统一使用：
  - `template-parts/loop/loop-solution-grid.php`
- 侧边栏产品推荐复用：
  - `template-parts/solution/sidebar-feature-product.php`
- 其他全局组件（如面包屑、TOC、上一篇按钮等）保持现有 `template-parts/components/*` 复用：
  - 列表页可视需求增加面包屑、筛选组件等，路径保持一致。

通过以上策略，保证：

- 解决方案在不同页面/模块中的卡片样式完全一致；
- 修改卡片组件的 UI 样式时，只需改动一处模板。

---

## 四、solution-archive-header.php 动态化方案

目标：  
将列表页顶部（标题、副标题、说明、Banner 图等）全部改为可在后台通过 ACF 配置，并保持原有 Elementor 样式结构。

### 4.1 字段读取逻辑设计

**绑定在 page-solution 上时：**

```php
$context_id = get_queried_object_id();

$title    = function_exists('get_field') ? get_field('solution_list_title', $context_id) : '';
$subtitle = function_exists('get_field') ? get_field('solution_list_subtitle', $context_id) : '';
$intro    = function_exists('get_field') ? get_field('solution_list_intro', $context_id) : '';
$banner   = function_exists('get_field') ? get_field('solution_archive_banner_image', $context_id) : '';

if (!$title) {
    $title = get_the_title($context_id);
}
```

**注意点：**

- 外层使用 `function_exists('get_field')`，避免在 ACF 未激活时报错；
- 文本使用 `esc_html()`，富文本使用 `wp_kses_post()`，既安全又保留必要的 HTML；
- 所有 Elementor 相关 class、`data-id`、`data-element_type` 等保持不变，只替换内部文本/图片。

### 4.2 模板结构建议

在保持现有 HTML 结构的前提下，将核心内容替换为变量输出：

- Banner 背景图：从 `$banner['url']` 输出到行内 `style` 或 `<img>` 标签；
- 标题、副标题：输出 `$title` 与 `$subtitle`；
- 说明文案：输出 `$intro`。

这样，列表页文案与视觉均可通过后台配置，无需改动代码。

---

## 五、layout-two-column-solution.php 动态化方案

目标：

- 中间区域：负责主列表（解决方案集合）渲染；  
- 侧边栏区域：负责推荐产品、推荐解决方案、分类筛选等模块；  
- 支持分页、默认排序与分类筛选。

### 5.1 列表查询（WP_Query）设计

1. 从 ACF 读取配置：

- 每页数量：

```php
$context_id = get_queried_object_id();

$posts_per_page = function_exists('get_field')
    ? (int) get_field('solution_list_items_per_page', $context_id)
    : 9;

if ($posts_per_page <= 0) {
    $posts_per_page = 9;
}
```

- 当前页码（兼容 `paged` 与 `page`）：

```php
$paged = max(1, get_query_var('paged'), get_query_var('page'));
```

- 默认排序规则（从 ACF 中读取）：

```php
$default_order = function_exists('get_field')
    ? get_field('solution_list_default_order', $context_id)
    : 'date_desc';

switch ($default_order) {
    case 'date_asc':
        $orderby = 'date';
        $order   = 'ASC';
        break;
    case 'menu_order':
        $orderby = 'menu_order';
        $order   = 'ASC';
        break;
    default:
        $orderby = 'date';
        $order   = 'DESC';
}
```

2. 组装 `WP_Query` 参数：

```php
$args = [
    'post_type'      => 'solution', // 若实际为 post 等，请相应修改
    'post_status'    => 'publish',
    'posts_per_page' => $posts_per_page,
    'paged'          => $paged,
    'orderby'        => $orderby,
    'order'          => $order,
];
```

3. 分类筛选（基于 URL 参数）：

- 例如列表页左侧有“行业分类”列表，点击后跳转至：  
  `/solution/?solution_cat=building`

模板中读取并应用筛选：

```php
$filter_cat = isset($_GET['solution_cat']) ? sanitize_text_field(wp_unslash($_GET['solution_cat'])) : '';

if ($filter_cat) {
    $args['tax_query'] = [
        [
            'taxonomy' => 'solution_category', // 或 category
            'field'    => 'slug',
            'terms'    => $filter_cat,
        ],
    ];
}

$solution_query = new WP_Query($args);
```

### 5.2 列表循环与卡片组件复用

列表循环中统一调用 `loop-solution-grid.php` 展示单条解决方案：

```php
if ($solution_query->have_posts()) :
    echo '<div class="elysia-solution-list-grid">';
    while ($solution_query->have_posts()) :
        $solution_query->the_post();
        get_template_part('template-parts/loop/loop', 'solution-grid');
    endwhile;
    echo '</div>';

    the_posts_pagination([
        'total'   => $solution_query->max_num_pages,
        'current' => $paged,
    ]);
else :
    // 输出“暂无解决方案”之类的提示
endif;

wp_reset_postdata();
```

**收益：**

- 所有地方（列表页、首页推荐、行业页推荐）都可以通过 `get_template_part('template-parts/loop/loop', 'solution-grid')` 复用统一的卡片样式；
- 更改卡片结构或样式只需修改一个文件。

### 5.3 布局中的侧边栏区域

根据现有 HTML 结构，将侧边栏划分为若干可插拔区块：

1. 推荐产品区域

- 继续直接引入：

```php
get_template_part('template-parts/solution/sidebar-feature-product');
```

- 若该模板内部已通过 ACF 或本地配置实现“产品选择/展示”，可保持现状。

2. 推荐解决方案区域（可选）

- 在 ACF 中提前配置 `solution_list_featured_ids`（Relationship 类型），选择若干解决方案；
- 在侧边栏模板中再次使用循环 + `loop-solution-grid` 输出，用于展示“精选解决方案”或“热门解决方案”。

3. 分类/行业筛选区域（可选）

- 使用 `wp_list_categories()` 或自定义 taxonomy 列表输出；
- 链接统一指向当前列表页，带上 `solution_cat` 参数，实现筛选。

---

## 六、推荐解决方案 / 热门解决方案模块

该模块不仅可用于列表页侧栏，也可用于首页、行业页等其他页面。

### 6.1 ACF 配置

在全局 Options 或某些页面新增字段：

- 字段名：`solution_featured_list`  
- 类型：`Relationship`（关联 `solution` 文章）  
- 用途：手工选择若干“重点展示”的解决方案。

### 6.2 模板调用示例

```php
if (function_exists('get_field')) {
    $featured_solutions = get_field('solution_featured_list', 'option'); // 或具体页面 ID

    if (!empty($featured_solutions) && is_array($featured_solutions)) :
        echo '<div class="elysia-solution-featured">';
        foreach ($featured_solutions as $post) :
            setup_postdata($post);
            get_template_part('template-parts/loop/loop', 'solution-grid');
        endforeach;
        wp_reset_postdata();
        echo '</div>';
    endif;
}
```

**特点：**

- 数据完全由编辑在后台手工选定，适合“重点推荐”场景；
- 展示 UI 仍然复用 `loop-solution-grid`，保证视觉一致。

---

## 七、列表页与详情页之间的联动

### 7.1 URL 与 post_type 统一

- 列表页：  
  - URL 示例：`/solution/`  
  - 模板：`page-solution.php`
- 详情页：  
  - URL 示例：`/solution/slug/`  
  - 模板：解决方案单篇模板（你已通过模块化拆分 `page-solution-detail.php` 完成）

通过统一的文章类型 `solution`（或统一的分类结构），列表页只需使用 `the_permalink()` 链接到详情页。

### 7.2 面包屑联动

- 列表页顶部 header（`solution-archive-header.php`）中可包含面包屑：  
  `首页 > 解决方案`
- 详情页的 `solution-detail-hero.php` 中也使用一致的面包屑逻辑：  
  `首页 > 解决方案 > 当前解决方案标题`
- 若需要兼容多入口（例如：行业页链接到某类解决方案），可在面包屑中增加“来源入口”逻辑，但基础链路始终包含“解决方案列表页”。

### 7.3 与产品页的联动

利用已有 `sidebar-feature-product.php`：

- 在解决方案详情页右侧展示“相关产品”；
- 若产品详情页需要反向展示“相关解决方案”，可在产品文章中增加 ACF 关系字段（例如 `related_solutions`），然后：  
  - 在产品详情模板中读取这个字段；  
  - 使用 `loop-solution-grid` 输出解决方案卡片；
  - 完成“产品 ↔ 解决方案”双向联动。

---

## 八、分页与 SEO 考量

### 8.1 分页实现

在 `layout-two-column-solution.php` 中：

- 使用 `the_posts_pagination()`，传入 `$solution_query->max_num_pages` 与 `$paged`；
- 确保 `rewrite` 规则设置合理，优先采用 `/solution/page/2/` 形式，而非 `?paged=2`，以获得更好的 SEO。

### 8.2 SEO 相关字段

- 列表页标题、副标题、介绍等文案尽量包含核心关键词，通过 ACF 配置；
- 筛选时（如 `?solution_cat=xxx`），在页面上明显展示当前分类名称，方便用户与搜索引擎理解当前列表的主题。

---

## 九、与其他页面之间的联动场景

### 9.1 首页模块：精选解决方案

- 在首页模板中增加一个区块“我们的解决方案”；  
- 使用 `WP_Query` 查询最新若干条 `solution`，或直接使用 `solution_featured_list` 字段；  
- 展示时仍然调用 `loop-solution-grid`。

### 9.2 行业入口页：按行业展示解决方案

- 行业页面本身通过 ACF 字段选择一个解决方案分类（如 `related_solution_category`）；  
- 模板中根据该分类执行 `WP_Query`，过滤对应 `solution`；  
- 使用 `loop-solution-grid` 输出，可作为该行业下的典型解决方案列表。

### 9.3 产品详情页：关联解决方案

- 产品文章中添加 ACF 关系字段 `related_solutions`；  
- 产品详情模板中读取该字段并循环输出 `loop-solution-grid`；  
- 用户从产品详情页即可跳转到对应解决方案详情，形成跨页面联动。

---

## 十、实施顺序建议

1. 在 ACF 中创建“解决方案列表页配置”字段组：  
   - 绑定至 `page-solution` 或 Options；  
   - 包含标题、副标题、说明、Banner 图、每页数量、默认排序等字段。
2. 改造 `solution-archive-header.php`：  
   - 用 ACF 字段填充列表页顶部标题、副标题、说明与背景图；  
   - 保持 Elementor 结构与样式不变。
3. 改造 `layout-two-column-solution.php`：  
   - 引入 `WP_Query`，根据 ACF 配置和 URL 参数查询解决方案列表；  
   - 使用 `loop-solution-grid` 渲染列表；  
   - 添加 `the_posts_pagination()` 处理分页；  
   - 在侧边栏调用 `sidebar-feature-product.php` 及推荐解决方案模块。
4. 若有需要，在 Options 或其他页面配置“精选解决方案”列表：  
   - 使用 ACF Relationship 字段 + `loop-solution-grid` 实现；  
   - 在首页、行业页等模块化复用。
5. 检查解决方案详情页与列表页之间的链接与面包屑：  
   - 确保列表页链接、详情页面包屑、产品页关联解决方案等链路全部打通。

通过上述步骤，即可在 **不增加额外插件** 的前提下，完成“解决方案列表”的全面动态化，并实现与详情页、产品页及其他入口页面之间的组件级复用和数据联动。

