# 解决方案详情动态化方案（更新版：支持单独录入与模块化编排）

> 目标：  
> - 为「解决方案」提供独立于博客文章的内容录入方式（独立菜单、独立字段、独立模板）  
> - 解决方案详情页既能像博客一样写长文，又能通过 ACF 做模块化编排  
> - 继续沿用现有 `page-solution-detail.php` + `template-parts/solution_detail/*` 结构  
> - 仅使用 ACF 插件和 WordPress 原生功能（自定义文章类型、模板、WP_Query 等）

适用范围：

- 模板文件：
  - `page-solution-detail.php`
  - `template-parts/solution_detail/*`
  - 相关组件文件：`template-parts/components/*`

---

## 一、内容模型：将「解决方案」单独建模

### 1.1 新增自定义文章类型：solution

为保证「添加解决方案」和「添加博客文章」在后台明显区分，建议新增一个自定义文章类型 `solution`：

- 菜单侧栏会出现「Solutions」或「解决方案」的独立入口
- 编辑解决方案时，不会和博客文章混在一起

配置要点（说明方案，实际实现可放在 `functions.php` 中）：

- 使用 `register_post_type('solution', $args)` 注册
- 关键参数：
  - `labels` 填写 Solutions/解决方案相关文案
  - `supports` 至少包含 `title`、`editor`、`thumbnail`、`excerpt`
  - `public` 设为 `true`
  - `has_archive` 可设为 `true`，方便后续做 `/solution/` 列表

这样，在后台就会有三类内容：

- 博客文章：`post`
- 产品：`site_product`
- 解决方案：`solution`

> 注意：当前你还没有任何 solution 文章，本方案为未来的最终状态设计。一旦注册了 `solution` post_type 并开始写内容，解决方案详情页即可按本方案渲染。

### 1.2 解决方案详情页的数据来源

解决方案详情页模板：`page-solution-detail.php`

当前逻辑：

- 通过 `post_id` 参数确定要展示的文章：

  ```php
  $elysia_solution_post_id = 0;
  if (get_query_var('post_id')) {
      $elysia_solution_post_id = (int) get_query_var('post_id');
  }
  if (!$elysia_solution_post_id && isset($_GET['post_id'])) {
      $elysia_solution_post_id = (int) $_GET['post_id'];
  }
  if ($elysia_solution_post_id <= 0) {
      $elysia_solution_post_id = get_the_ID();
  }
  $elysia_solution_post = null;
  if ($elysia_solution_post_id > 0) {
      $elysia_solution_post = get_post($elysia_solution_post_id);
  }
  ```

- 将 `$elysia_solution_post` 注入全局 `$post`：

  ```php
  if ($elysia_solution_post instanceof WP_Post) {
      global $post;
      $post = $elysia_solution_post;
      setup_postdata($post);
  }
  ```

最终目标：

- 在后台通过「Solutions」菜单新增 `solution` 文章
- 前端访问详情页时，通过 `post_id` 指定要展示哪一篇 solution
- 博客文章仍然在「文章（Posts）」里编辑，两者录入方式完全分离

---

## 二、解决方案详情的「内容 + 编排」双模式

解决方案详情页需要两种能力：

1. 像博客一样写长文：`the_content()` 输出正文  
2. 按业务模块编排：例如「痛点」「解决方案」「关键优势」「应用场景」「FAQ」「CTA」等模块

可以在 `solution` 文章上，通过 ACF 提供双模式。

### 2.1 模式开关字段

在 `solution` 文章类型上新增字段组：`Solution Detail Settings`，包含模式开关：

- 字段：`solution_detail_layout_mode`
  - 类型：`select`
  - 选项：
    - `simple_content`：简单模式（完全使用 WordPress 正文编辑器）
    - `flexible_layout`：编排模式（使用 ACF 模块化布局）
  - 默认值：`simple_content`

在 `template-parts/solution_detail/solution-detail-content.php` 中：

- 当为简单模式时，保持当前逻辑，仅输出：

  ```php
  <div class="elementor-widget-container elysia-article-content">
      <?php the_content(); ?>
  </div>
  ```

- 当为编排模式时，改为遍历 ACF Flexible Content 字段输出模块（见 2.2）。

### 2.2 编排模式：使用 ACF Flexible Content 构建模块

在同一 `Solution Detail Settings` 字段组中新增：

- 字段：`solution_layout_blocks`
  - 类型：`flexible_content`
  - Label：`解决方案页面模块编排`
  - 仅当 `solution_detail_layout_mode == flexible_layout` 时显示

建议的模块类型：

1. `hero_intro`（首屏简介增强）
   - 字段：
     - `hero_kicker`：上方小标题（如「应用场景：电力与能源」）
     - `hero_subtitle`：副标题
     - `hero_highlight_points`：关键卖点列表（Repeater）

2. `problem_section`（客户痛点）
   - 字段：
     - `title`：模块标题
     - `content`：WYSIWYG 或要点列表（Repeater）

3. `solution_section`（解决方案介绍）
   - 字段：
     - `title`
     - `content`：WYSIWYG

4. `features_grid`（关键优势/特性）
   - 字段：
     - `title`
     - `items`（Repeater）：
       - `icon`（可选）
       - `label`
       - `description`

5. `applications`（应用场景）
   - 字段：
     - `title`
     - `items`（Repeater：场景名称 + 简短描述）

6. `pricing_note`（价格/配置说明）
   - 字段：
     - `title`
     - `content`：WYSIWYG

7. `faq`（常见问题）
   - 字段：
     - `items`（Repeater）：
       - `question`
       - `answer`（WYSIWYG）

8. `cta`（结尾 Call To Action）
   - 字段：
     - `title`
     - `description`
     - `button_label`
     - `button_link`

在 `solution-detail-content.php` 中伪代码：

```php
$mode = function_exists('get_field') ? get_field('solution_detail_layout_mode') : '';

if ($mode === 'flexible_layout' && function_exists('have_rows') && have_rows('solution_layout_blocks')) {
    while (have_rows('solution_layout_blocks')) {
        the_row();
        $layout = get_row_layout();
        // 根据 $layout 输出不同模块
    }
} else {
    ?>
    <div class="elementor-widget-container elysia-article-content">
        <?php the_content(); ?>
    </div>
    <?php
}
```

对编辑者的意义：

- 想快速输出一篇解决方案：选择简单模式，仅编辑正文
- 想做更营销化的落地页：选择编排模式，按模块填 ACF 字段

---

## 三、ACF 字段分布与用途（更新）

相较于旧方案，本版强调：

- 所有与「解决方案详情内容」强相关的字段，挂在 `solution` 文章上
- 页面模板 `page-solution-detail.php` 只负责编排，不存具体业务数据

### 3.1 挂在 solution 文章上的字段组：Solution Detail Settings

Location：

- `post_type == solution`

字段列表建议：

1. 布局模式与模块编排

- `solution_detail_layout_mode`
  - 类型：`select`，`simple_content` / `flexible_layout`
- `solution_layout_blocks`
  - 类型：`flexible_content`，用于模块化编排

2. 详情页显示控制与辅助字段

- `solution_detail_show_toc`
  - 类型：`true_false`
  - 标签：`是否显示目录（TOC）`
  - 用途：控制 `components/toc.php` 在 solution 详情中是否输出

- `solution_detail_share_title`
  - 类型：`text`
  - 默认值：`Share`
  - 用途：左侧分享栏标题

- `solution_detail_sidebar_video_url`
  - 类型：`url`
  - 用途：右侧视频地址

- `solution_detail_sidebar_video_aspect_ratio`
  - 类型：`text`
  - 默认值：`16/9`
  - 用途：右侧视频宽高比

3. Related Solutions 配置

- `solution_detail_related_mode`
  - 类型：`select`
  - 选项：
    - `auto_category`：按分类自动推荐
    - `manual`：手动选择

- `solution_detail_related_manual`
  - 类型：`relationship`
  - `post_type`：`solution`

- `solution_detail_related_title`
  - 类型：`text`
  - 默认：`Related Solutions`

### 3.2 挂在 Page（列表页/详情容器页）上的字段组：Solution Archive Settings

现有字段组 `Solution Archive Settings` 已挂在 `page-solution.php`（解决方案列表页）。

建议将其 Location 扩展为：

- `page_template == page-solution.php`
- `page_template == page-solution-detail.php`

好处：

- 右侧 Feature Product 使用同一字段 `solution_featured_products`，可在：
  - 列表页 Page 配一套
  - 详情容器 Page 再配一套

若后续希望 Feature Product 与具体 solution 更紧密，可新增字段：

- `solution_detail_featured_products`（挂在 solution 文章上）
- 在 `sidebar-feature-product.php` 中：
  - 优先读取当前 solution 上的 `solution_detail_featured_products`
  - 若为空，再回退到当前 Page 的 `solution_featured_products`

---

## 四、模板层面的联动与更新

### 4.1 page-solution-detail.php：编排器角色保持不变

文件：`page-solution-detail.php`

职责：

- 根据 `post_id` 找到要展示的 solution 文章
- 设置全局 `$post`
- 调用：
  - `solution-detail-hero`
  - `solution-detail-sidebar-share`
  - `components/toc`
  - `solution-detail-content`
  - `solution-detail-sidebar-video`
  - `sidebar-feature-product`
  - `components/post-navigation`
  - `solution-detail-related`

不包含：

- 任何 ACF 字段定义
- 任何复杂查询逻辑

这样后续即使改用 `single-solution.php`，也可以沿用同样的模块拆分方式。

### 4.2 solution-detail-hero.php：首屏标题区块

文件：`template-parts/solution_detail/solution-detail-hero.php`

当前功能：

- 使用 `get_the_ID()`、`get_the_title()`、`get_the_date()` 输出：
  - 面包屑：`Home > Solution > 当前标题`
  - 标题：当前 solution 标题
  - 日期：发布时间

动态化策略：

- 内容已经完全依赖当前 `$post`，不需要额外 ACF
- 若未来需要 Hero 背景图或副标题：
  - 可在 `Solution Detail Settings` 中新增：
    - `solution_detail_hero_subtitle`
    - `solution_detail_hero_background_image`
  - 在本文件中通过 `get_field()` 填充 section 背景

面包屑复用建议：

- 可在内部调用 `get_template_part('template-parts/components/breadcrumbs')`
- 将「Home / Solution / Title」逻辑部分下沉到全站通用 `breadcrumbs.php` 中

### 4.3 solution-detail-content.php：正文 + 模块化

文件：`template-parts/solution_detail/solution-detail-content.php`

逻辑调整：

- 读取 `solution_detail_layout_mode` 字段：
  - `simple_content`：
    - 保持现有 `the_content()` 输出
  - `flexible_layout`：
    - 遍历 `solution_layout_blocks`，按不同 layout 类型输出对应模块

与 TOC 的联动：

- 保持 `.elysia-article-content` 容器不变（或在简单模式下使用）
- `components/toc.php` 中 `data-settings` 的 `container` 指向 `.elysia-article-content`

### 4.4 components/toc.php：兼容 blog 与 solution

文件：`template-parts/components/toc.php`

现状：

- 仅在 `is_singular('post')` 时读取 `blog_detail_toc_enabled` 控制开关

增强：

- 对 `is_singular('solution')` 的场景：
  - 使用 `solution_detail_show_toc` 字段控制
  - 若为 false，`$elysia_show_toc = false`，直接 return

这样：

- Blog 和 Solution 共用同一个 TOC 组件
- 两种类型各自有独立的显示开关字段

### 4.5 solution-detail-sidebar-share.php：标题来自 solution 字段，按钮复用组件

文件：`template-parts/solution_detail/solution-detail-sidebar-share.php`

改造：

- 将标题 `<p>Share</p>` 替换为：
  - 若 `solution_detail_share_title` 有值，则输出该字段
  - 否则回退为 `"Share"`

- 分享按钮：
  - 在当前 layout 内，加入 `get_template_part('template-parts/components/share-buttons')`
  - 按 Blog 共用的 share 组件输出实际按钮和链接

意义：

- 标题可按解决方案定制（多语言/不同文案）
- 按钮 UI 与全站其它页面保持一致

### 4.6 solution-detail-sidebar-video.php：优先文章级配置，必要时回退 Page 级

文件：`template-parts/solution_detail/solution-detail-sidebar-video.php`

逻辑：

1. 优先读取当前 solution 文章上的字段：
   - `solution_detail_sidebar_video_url`
   - `solution_detail_sidebar_video_aspect_ratio`

2. 若为空，可选择性回退到容器 Page 字段：
   - `solution_sidebar_video_url`
   - `solution_sidebar_video_aspect_ratio`

3. 保留所有 Elementor 导出的 class 和 data 属性，只替换：
   - `data-settings` 中的 `youtube_url`
   - 内部 `<iframe>` 的 `src`

### 4.7 sidebar-feature-product.php：Feature Product 组件复用

文件：`template-parts/solution/sidebar-feature-product.php`

现状：

- 使用 `get_queried_object_id()` 作为 context，从当前 Page 的 `solution_featured_products` 字段读取推荐产品

方案：

- 将 `Solution Archive Settings` 字段组扩展到 `page-solution-detail.php` 使用的 Page
- 这样：
  - 列表页和详情容器页都可配置自己的 Feature Product 列表
  - Template 仍然复用一份 `sidebar-feature-product.php`

后续增强（可选）：

- 在 `solution` 文章上增加 `solution_detail_featured_products`
- 在组件中优先读取文章级字段，空时再回退 Page 字段

### 4.8 solution-detail-related.php：从 solution 文章查 Related Solutions

文件：`template-parts/solution_detail/solution-detail-related.php`

依据字段：

- `solution_detail_related_mode`
- `solution_detail_related_manual`
- `solution_detail_related_title`

行为：

1. 标题：
   - 若 `solution_detail_related_title` 非空，使用该字段
   - 否则使用默认 `"Related Solutions"`

2. 数据来源：
   - 若 mode 为 `manual` 且 `solution_detail_related_manual` 非空：
     - 直接使用 Relationship 字段中的 solutions
   - 否则（auto_category）：
     - 使用当前 solution 的分类（如 `solution_category`）
     - 通过 `WP_Query` 查询同分类下其他 solutions（排除当前文章），数量上限 4
     - 若分类为空，则回退查询最新 solutions

3. UI 复用：
   - 建议复用解决方案列表卡片模板（如 `template-parts/loop/loop-solution-grid.php`）
   - 在循环中调用该 loop 模板，保证详情页底部卡片与列表页样式一致

当还没有任何 solution 文章时：

- 该模块将不会输出任何卡片，但会保持页面不报错

---

## 五、与其他页面的联动与分工

### 5.1 与解决方案列表页（page-solution.php）

- 列表页负责：
  - 查询 `solution` 文章集合
  - 使用统一卡片模板展示
- 详情页负责：
  - 展示某一篇 solution 的完整内容与编排
  - 右侧 Feature Product 与 Related Solutions 模块

通过这样分工：

- 列表页和详情页共用 solution 这个内容模型
- 录入一次 solution，可在多个入口展示（列表、行业页、产品页关联等）

### 5.2 与 Blog 详情页（page-blog-detail.php）

- Blog 使用 `post` 文章类型
- Solution 使用 `solution` 文章类型

共用组件：

- TOC：`components/toc.php`
  - Blog：`blog_detail_toc_enabled`
  - Solution：`solution_detail_show_toc`
- 分享按钮：`components/share-buttons.php`
- Post Navigation：`components/post-navigation.php`

区别：

- 字段组完全不同：
  - Blog 使用博客专用字段组
  - Solution 使用 `Solution Detail Settings`

### 5.3 与产品页（site_product）

以当前已有内容为基础：

- 产品 post_type：`site_product`
- 产品分类：`product_category`

联动方向：

- 从 solution 指向 product：
  - 通过 `solution_featured_products` 或 `solution_detail_featured_products` 显示关联产品
- 从 product 指向 solution（可选后续）：
  - 在 `site_product` 上新增 `related_solutions`（relationship，post_type=solution）
  - 在产品详情模板中输出相关解决方案列表（复用 solution 列表卡片模板）

---

## 六、编辑者实际使用流程（与博客完全区分）

1. 添加解决方案内容
   - 后台左侧菜单选择「Solutions」→「Add New」
   - 填写：
     - 标题（必填）
     - 正文（在简单模式下直接展示）
     - ACF 字段：
       - 布局模式（简单/编排）
       - 编排模块（可选）
       - TOC 开关
       - 分享标题
       - 右侧视频 URL/宽高比
       - Related Solutions 配置

2. 添加博客文章内容
   - 与现在一样：菜单「文章」→「写文章」
   - 使用 Blog 专属 ACF 字段组

3. 列表页与详情页展示
   - 解决方案列表页 `page-solution.php` 通过 `WP_Query` 查询 `solution` 文章
   - 解决方案详情页 `page-solution-detail.php` 通过 `post_id` 定位具体 solution
   - 博客列表与详情页仍然基于 `post` 类型和博客专用模板

通过以上设计：

- 从内容模型上，解决方案与博客彻底分开
- 从编辑体验上，解决方案可选择「简单模式」或「模块化编排」模式
- 从实现上，仅依赖：
  - WordPress 原生功能：post_type、模板体系、WP_Query 等
  - ACF 字段：true_false、select、relationship、flexible_content 等

