# 文章列表动态化方案（page-blog.php）

## 1. 背景与目标

- 当前 `page-blog.php` 与 `template-parts/blog` 中的模板全部是从 `swforming.com` 的静态 HTML 迁移而来，大部分内容（文章卡片、分页、文案等）仍然是**写死的静态 HTML**。
- 目标：
  - 使用 **WordPress 原生文章系统（post）+ ACF 插件** 实现文章列表页的完全动态化。
  - 不使用除 ACF 以外的任何插件。
  - 在不破坏现有 **Elementor 导出的 HTML 结构与 CSS class** 的前提下，实现动态数据渲染，保证页面样式效果保持不变。
  - 尽可能将模块做成可复用组件，方便以后在其它页面或区块中调用。

---

## 2. 当前模板结构概览

### 2.1 页面入口：page-blog.php

文件：`page-blog.php`

- 模板名称：`文章列表`
- 结构：
  - 引入头部 `get_header()`
  - 加载 Elementor 导出的样式文件：`post-1345.css`、`widget-posts.min.css`
  - 主体 `<main>` 内部，通过 `get_template_part` 引用多个 blog 模块：

    ```php
    get_template_part('template-parts/blog/blog', 'hero');
    get_template_part('template-parts/blog/blog', 'loop-recent-stories');
    get_template_part('template-parts/blog/blog', 'pagination');
    get_template_part('template-parts/blog/blog', 'sidebar-share');
    get_template_part('template-parts/blog/blog', 'sidebar-latest-headlines');
    get_template_part('template-parts/blog/blog', 'cta-start-business');
    get_template_part('template-parts/blog/blog', 'section-popular-stories');
    ```

- 当前所有文章内容均是静态 HTML，未使用 `WP_Query`。

### 2.2 模块文件概述

所有模块路径：`template-parts/blog/`

1. `blog-hero.php`  
   - 顶部 Hero 横幅，只包含一个标题 `Blog`（静态）。

2. `blog-loop-recent-stories.php`  
   - 中部主文章列表区域：
     - 上方有小标题 “On Top” 与 “Recent Stories”（静态文案）。
     - 下方是一个包含大量 `<article>` 的静态列表，每篇文章包括：
       - 标题、链接、发布日期、评论数文案“No Comments”、摘要、Read More 按钮等。
     - 底部使用 `get_template_part('template-parts/blog/blog', 'pagination');` 引入分页模板。

3. `blog-pagination.php`  
   - 当前为完全静态 HTML：
     - 固定 `data-page="1" data-max-page="51"` 和 `data-next-page`。
     - `<nav>` 中页码和 “Next »”、“Previous” 均写死指向 `swforming.com`。

4. `blog-sidebar-share.php`  
   - 侧边栏分享区：
     - 标题 “Share This Page” 写死。
     - 具体分享按钮为静态 HTML，仅渲染图标，没有真实分享链接逻辑。

5. `blog-sidebar-latest-headlines.php`  
   - 侧边栏“New Update”最新文章区：
     - 标题 “New Update” 写死。
     - 内部是 4 篇固定文章的静态 HTML 列表。

6. `blog-cta-start-business.php`  
   - 右侧 CTA 小区块：
     - Divider 文案 “Strat Our Business Now”（有拼写错误）。
     - 标题 “Get In Touch With Sunway”。
     - 都是静态文案，没有按钮/链接。

7. `blog-section-popular-stories.php`  
   - 页面底部“Most Popular Stories”区：
     - 小标题 “On Trend”和标题 “Most Popular Stories” 静态。
     - 下方为 4 篇固定文章的静态卡片网格。

---

## 3. 数据模型设计（WordPress + ACF）

### 3.1 WordPress 原生文章数据

- 使用默认 `post` 文章类型存储博客文章：
  - 标题：`post_title`
  - 内容：`post_content`
  - 摘要：`post_excerpt` 或 `wp_trim_words()` 从正文生成
  - 发布时间：`post_date`
  - 分类、标签：`category` / `post_tag`
  - 特色图片：`post_thumbnail`

- 文章列表（Recent Stories、Latest Headlines、Popular Stories）均使用 `WP_Query` 或 `get_posts()` 从 `post` 中获取数据。

### 3.2 ACF 字段组设计

统一在 `functions.php` 中通过 `acf_add_local_field_group()` 注册（保持与产品模块相同的管理方式），主要分为两类：

#### 3.2.1 博客列表页字段组：Blog Archive Settings

- 适用范围：
  - `post_type == page`
  - 且页面模板为 `page-blog.php`
- 字段建议：

1. Hero 区域
   - `blog_hero_title`（文本）
     - Hero 主标题，默认可留空，留空时回退到 `get_the_title()`。
   - `blog_hero_subtitle`（文本，可选）
   - `blog_hero_background_image`（图像，可选）
     - 用于替换当前 CSS 背景图（如果需要）。

2. 主列表控制
   - `blog_main_query_posts_per_page`（数字，默认 10）
   - `blog_main_query_category`（taxonomy，关联 `category`，可多选）
     - 控制 Recent Stories 列表的分类过滤，留空则显示所有。

3. 侧边栏 – 最新文章区
   - `blog_sidebar_latest_title`（文本，默认 “New Update”）
   - `blog_sidebar_latest_posts_count`（数字，默认 4）
   - `blog_sidebar_latest_category`（taxonomy，可选）
     - 用于限制只显示某些分类文章。

4. CTA 区块
   - `blog_cta_divider_text`（文本，默认 “Start Our Business Now”）
   - `blog_cta_title`（文本，默认 “Get In Touch With Sunway”）
   - `blog_cta_button_label`（文本，可选）
   - `blog_cta_button_link`（链接或页面选择，可选）

5. 底部热门文章区
   - `blog_popular_divider_text`（文本，默认 “On Trend”）
   - `blog_popular_title`（文本，默认 “Most Popular Stories”）
   - `blog_popular_posts`（relationship，关联 `post`，多选最多 4 条）
     - 手动选择“最受欢迎”文章，避免统计插件。

#### 3.2.2 全站博客通用设置：Blog Global Options（可选）

- 适用范围：`options_page == acf-options` 或新建 `Blog Options` 页面。
- 字段可以与上述部分字段重合，作为**全局默认值**，页面级字段为空时回退使用：

  - `blog_global_hero_title`
  - `blog_global_sidebar_share_title`
  - `blog_global_share_networks`（可做 repeater，暂不强制）

> 若希望所有博客列表样式统一，建议将「默认设置」做在 Options Page，文章列表页面只在有差异时覆盖。

---

## 4. 各模块动态化方案

### 4.1 Hero 模块：blog-hero.php

**HTML 结构保持不变，只替换标题文本。**

- 原始标题：硬编码 `Blog`。
- 动态化逻辑：
  1. 优先使用页面级 ACF 字段 `blog_hero_title`。
  2. 若为空，则使用当前页面标题 `get_the_title()`。
  3. 若未来有全局配置，则再加一层 fallback：options 中的 `blog_global_hero_title`。

- 可选增强：
  - 使用 `blog_hero_background_image` 字段，将背景图 URL 通过内联 `style` 或 `data` 写入当前 section，而不改动 class 与结构。

### 4.2 主列表模块：blog-loop-recent-stories.php

**目标：用 `WP_Query` 动态输出文章列表，保持原有元素结构与 class。**

1. 静态文案处理
   - “On Top”、“Recent Stories”：
     - 可保持写死不动，或者使用 ACF 字段：
       - `blog_recent_badge_text`（默认 “On Top”）
       - `blog_recent_title`（默认 “Recent Stories”）

2. 文章循环逻辑（PHP 层）

   - 使用 `elysia_get_blog_posts_query()` 这样的辅助函数（在 `functions.php` 中定义）：
     - 入参：`$paged`、`$posts_per_page`、`$category_ids`。
     - 内部使用 `WP_Query`：
       - `post_type = 'post'`
       - `post_status = 'publish'`
       - `posts_per_page` 从 ACF 字段 `blog_main_query_posts_per_page` 读取。
       - `paged` 使用类似 `elysia_get_product_list_paged()` 的分页函数。
       - 若 `blog_main_query_category` 有值，则添加 `tax_query` 过滤分类。

   - 在 `blog-loop-recent-stories.php` 中：
     - 调用此函数获取 `$query`。
     - 使用 `while ($query->have_posts())` 循环输出 `<article>`，保持现有 class：
       - 标题：`the_title()`；链接：`get_permalink()`
       - 日期：`get_the_date()`。
       - 评论：`comments_number()` 或直接省略“不评论”文案。
       - 摘要：优先用 `get_the_excerpt()`，否则用 `wp_trim_words(get_the_content(), 40)`。
       - “Read More »” 文案可写死或通过 ACF 全局字段控制。

3. 与分页模块联动
   - 推荐做法：
     - 在 `blog-loop-recent-stories.php` 内部调用 `get_template_part('template-parts/blog/blog', 'pagination');`。
     - 同时，将当前 `$query` 放入全局变量或 `GLOBALS['elysia_blog_query']` 中，供 `blog-pagination.php` 使用。

### 4.3 分页模块：blog-pagination.php

**将静态页码替换为 `paginate_links()` 生成的动态分页，样式保持原有结构。**

1. 获取当前查询对象：
   - 优先使用从主列表传入的 `$query`（如存放在全局）。
   - 若不存在，则退回到全局 `$wp_query`。

2. 使用 `paginate_links()` 生成分页链接：
   - `current` 为 `max(1, get_query_var('paged'))`
   - `total` 为 `$query->max_num_pages`

3. HTML 结构：
   - 保留外层 `<nav class="elementor-pagination">`。
   - 将 `paginate_links()` 返回的 HTML 进行简单包装，使其 class 接近当前结构：
     - 当前主题使用 `page-numbers`、`prev`、`next` 等 class，可以直接利用。

4. 若只需第一页（总页数为 1）：
   - 可以不输出 `<nav>`，保持体验简洁。

### 4.4 侧边分享模块：blog-sidebar-share.php

**目前只是展示图标，没有真实分享 URL；动态化主要考虑标题与配置可复用。**

1. 文案动态化
   - 使用 ACF：
     - 页面级字段 `blog_sidebar_share_title`
     - 或全局字段 `blog_global_sidebar_share_title`
   - 逻辑：页面级优先，其次全局，最后默认 “Share This Page”。

2. 分享链接实现（可选）
   - 使用 WordPress 原生函数 `get_permalink()` 获取当前页面 URL。
   - 针对每种社交网络生成分享 URL（纯字符串拼接，无需插件）：
     - Facebook: `https://www.facebook.com/sharer/sharer.php?u=...`
     - Twitter(X): `https://twitter.com/intent/tweet?url=...&text=...`
     - LinkedIn: `https://www.linkedin.com/shareArticle?mini=true&url=...`
     - WhatsApp: `https://api.whatsapp.com/send?text=...`
     - Email: `mailto:?subject=...&body=...`
   - 保持 class 不变，只将原本的 `<div role="button">` 替换为 `<a href="分享链接" target="_blank">`。

3. 模块复用
   - 此区块可在其它页面（如产品详情页）重复使用，通过 ACF 选项控制是否显示。

### 4.5 侧边最新文章模块：blog-sidebar-latest-headlines.php

**用 `WP_Query` 动态获取 N 条最新文章，结构不变。**

1. 标题
   - ACF 字段 `blog_sidebar_latest_title`（默认 “New Update”）。

2. 列表内容
   - 使用 WP_Query：
     - `post_type = 'post'`
     - `posts_per_page` 来自 `blog_sidebar_latest_posts_count`（默认 4）
     - `orderby = 'date'`，`order = 'DESC'`
     - 可选 `category__in` 来自 `blog_sidebar_latest_category`

3. 输出结构：
   - 循环中生成多个 `<article>`，保持现有 class 与 HTML 结构，只替换数据为动态内容。

4. 复用
   - 此模块可在其它包含侧边栏的页面复用，只需在对应模板调用同一 `template-part`。

### 4.6 CTA 模块：blog-cta-start-business.php

**动态化标题与副标题，并可选增加按钮。**

1. 文案
   - 使用 ACF 字段：
     - `blog_cta_divider_text` → 替换 “Strat Our Business Now”
     - `blog_cta_title` → 替换 “Get In Touch With Sunway”

2. 按钮（可选增强）
   - 若新增字段 `blog_cta_button_label` 和 `blog_cta_button_link`：
     - 在原有结构下新增一个 `<a>` 按钮，使用主题已有 button class。
   - 若字段为空，则不输出按钮，保持当前视觉。

3. 复用
   - 此 CTA 模块可在产品列表页、联系我们页复用，通过 ACF 选项控制不同页的文案。

### 4.7 热门文章模块：blog-section-popular-stories.php

**用 ACF Relationship 手动选择“热门文章”，避免依赖统计插件。**

1. 标题
   - 使用字段：
     - `blog_popular_divider_text`：替换 “On Trend”
     - `blog_popular_title`：替换 “Most Popular Stories”

2. 文章来源
   - ACF 字段 `blog_popular_posts`（relationship，关联 `post`，最多 4 条）：
     - 在后台手动选择 4 篇文章。
   - 模板中按选择顺序循环 `$posts`，输出 `<article>` 列表：
     - 标题、链接、摘要皆来自真实文章。

3. 当未选择热门文章时：
   - 可以降级为自动取最新 4 篇文章，或者整个区块隐藏。

4. 复用
   - 可在首页、产品详情页底部等位置调用同一模板，通过判断当前页面环境决定是否显示。

---

## 5. 模块复用与函数封装建议

### 5.1 共用查询辅助函数

在 `functions.php` 中新增一组函数，用于统一文章查询逻辑，便于多个模块调用：

- `elysia_get_blog_archive_page_id()`：返回当前使用 `page-blog.php` 模板的页面 ID（用于读取 ACF）。
- `elysia_get_blog_main_query($paged)`：返回主列表的 WP_Query。
- `elysia_get_blog_latest_posts($limit, $category_ids)`：用于侧边“New Update”。
- `elysia_get_blog_popular_posts()`：读取 `blog_popular_posts` 字段。

### 5.2 ACF 数据回退策略

为了减少配置成本，建议所有文案字段遵循统一的“三级回退”策略：

1. 页面级字段（针对当前 Blog 列表页面设置）。
2. 全局 Blog Options（全站默认）。
3. 硬编码默认文案（与当前静态文案一致）。

### 5.3 与产品模块的统一

- 当前主题产品列表已经通过类似 `elysia_get_product_pages_query()` 实现了统一查询。
- 博客列表可以保持同样的模式，后续有利于维护与二次开发。

---

## 6. 实施步骤建议

1. 在 `functions.php` 中通过 `acf_add_local_field_group()` 注册上述博客相关字段组。
2. 在 `functions.php` 中实现文章查询相关的辅助函数。
3. 按模块顺序逐个改造：
   - 修改 `blog-hero.php` → 动态标题
   - 修改 `blog-loop-recent-stories.php` → 写 `WP_Query` + 动态循环
   - 修改 `blog-pagination.php` → 动态分页
   - 修改 `blog-sidebar-share.php` → 动态标题 + 可选分享链接
   - 修改 `blog-sidebar-latest-headlines.php` → 最新文章查询
   - 修改 `blog-cta-start-business.php` → 动态文案 (+ 按钮可选)
   - 修改 `blog-section-popular-stories.php` → ACF Relationship 选择文章
4. 在后台：
   - 为文章列表页选择模板 `文章列表（page-blog.php）`。
   - 配置 ACF 字段（英雄区标题、热门文章等）。
5. 测试：
   - 验证不同终端下样式与原站一致。
   - 检查分页正确性（多页情况下）。
   - 验证各模块的 ACF 配置变更能实时反映到前端。

---

以上方案严格基于现有 `page-blog.php` 与 `template-parts/blog` 的结构设计，只使用 **ACF + WordPress 原生功能** 实现文章列表动态化，并考虑了模块复用与后续扩展。***
